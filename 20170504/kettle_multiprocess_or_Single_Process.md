[TOC]



# kettle multiprocess or Single Process

&ensp;&ensp;&ensp;&ensp;使用kettle差不多三年了，后来在出差的时候，同事和我说kettle是单线程数据抽取，回来好好研究了一下，发现kettle并不是单线程，kettle可以使用多线程


## 多线程

&ensp;&ensp;&ensp;&ensp;声明目前说的多线程指的是转换流程，不涉及作业流程。

&ensp;&ensp;&ensp;&ensp;一个普通的转换，文本文件读取数据》JS脚本》oracle存储过程》表输出。这个转换中我们可以在JS脚本和oracle存储过程的步骤选择复制的数量(step copy)

 &ensp;&ensp;&ensp;&ensp;在现场的测试环境中，将这两个步骤复制4个，可以提高一倍效率，之前是18分钟抽取到oracle的表，现在时间缩短为9分钟，不过在windows服务器，cpu可能会有一个极端变换，由1%到98%在平稳到2%


 ### 数据行分发

  &ensp;&ensp;&ensp;&ensp;数据行分发其实就是我们把一个步骤拷贝的记录发送到四个步骤拷贝，工作是采用轮询方式执行，也就是如果有四份拷贝，第一份拷贝获取第一条记录，第二份拷贝获取第二条记录，第四份拷贝获取第四条记录，第五条数据会被第一份拷贝获取

   &ensp;&ensp;&ensp;&ensp;在这里稍微介绍一下数据发送(data send)拥有两张模式一种是轮流(round-robin),一种是复制(copy send)
   一般情况下我们只是使用轮流模式，但是解释一下，如果一个输入端，两个输出端，如果选择第一种轮流模式，那么数据可能会分为两等分，如果是选择第二种复制模式，就是两个输出端一样。

 ### 记录行合并

   &ensp;&ensp;&ensp;&ensp;记录行合并其实前面第一个数据行分发后在合并到下一个控件的，可以这样理解，一个输入端，一个处理控件(复制4次)，一个输出端，在处理控件四次后，数据合并到一起到输出端，输出端不能保证数据的顺序


 ### 记录行再分发

 &ensp;&ensp;&ensp;&ensp;其实就是数据行分发后再次分发，如果前者是四个，后者是两个，那么就会有8个缓存区。建议使用后面的数据流水线，就是前面几个，后面几个

 #### 数据流水线

 &ensp;&ensp;&ensp;&ensp;数据流水线，就是前面几个，后面几个，就是那个在那条路，就一直在那条路

 

- 多线程问题

    - 转换中在同一张表既有插入又有查询

    很难保证数据一致性，前者在插入，后者的会话很难读取到所有当前的数据

    建议插入和读取分成两个转换

