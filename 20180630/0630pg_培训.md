[TOC]

# 0630pg_培训

## MVCC

无MVCC的案例



转账 统计总量

ext4

硬件架构

log=order

### undo

​	oracle一类数据库通过将数据复制到undo表空间，来保证数据一致性的查询。



​	版本号



### most version

​	postgresql 是通过多版本来避免读写导致的不一致

​	

​	postgresql 更新的数据如何判断是之前的数据的替换

​	xmin,xmax

 	insert  xmin  n，xmax 为0

​	delete xmin n ,xmax n+m

​        update  delete xmin n ,xmax n+m

​                       insert  xmin n+m ,xmax 0



​        pg_clog  事务状态  commitlog 0x00  0x01 0x02 0x03

​	

​	pg_database datfrozenxid 

​        age(datfrozenxid)



​       pg_class refrozenxid

​       relfrozenxid 为0 需要排除，age年龄的计算默认将0置为最大？

​	



​	postgresql mvcc

​	xmin,xmax

 	insert  xmin  n，xmax 为0

​	delete xmin n ,xmax n+m

​        update  delete xmin n ,xmax n+m

​                       insert  xmin n+m ,xmax 0



​	那么当新启一个事务来查询数据时，

​	第一点检查pg_clog，是否提交

​	第二点检查活动的xid

​	如果新启的事务大于一些活动xid 

​	



​	

事务id与pg_clog的日志大小有关

​        

​	

​		

​	postgresql 多版本与重复读，不可重复度，幻读

​	现在问题是多版本如何与原子性一致性



​	索引  key = 列值 value=ctid

​	

​	xmin,xmax 

## 实例恢复

	### 逻辑恢复



### 物理恢复



#### 基础备份+归档

#### 基础备份+wal日志+时间点/时间线/检查点





​	

​	





